---
import {
  loadEventServiceConfig,
  loadEventListServiceConfig,
  loadTicketDefinitionListServiceConfig,
  loadScheduleListServiceConfig,
  loadOccurrenceListServiceConfig,
} from '@wix/events/services';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { EventDetails } from '@/components/events/EventDetails/EventDetails';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Load initial data server-side
const [eventServiceConfigResult, eventListServiceConfig] = await Promise.all([
  loadEventServiceConfig({ slug }),
  loadEventListServiceConfig(),
]);

if (eventServiceConfigResult.type === 'notFound') {
  return Astro.redirect('/404');
}

const eventId = eventServiceConfigResult.config.event._id!;
const recurringCategoryId =
  eventServiceConfigResult.config.event.dateAndTimeSettings?.recurringEvents
    ?.categoryId ?? undefined;

const [
  ticketDefinitionListServiceConfig,
  scheduleListServiceConfig,
  occurrenceListServiceConfig,
] = await Promise.all([
  loadTicketDefinitionListServiceConfig({ eventId }),
  loadScheduleListServiceConfig({ eventId, limit: 2 }),
  loadOccurrenceListServiceConfig({ recurringCategoryId }),
]);
---

<BaseLayout>
  <title>Event Details</title>
  <meta name="description" content="Event Details" />

  <EventDetails
    client:load
    slot="body"
    eventServiceConfig={eventServiceConfigResult.config}
    eventListServiceConfig={eventListServiceConfig}
    ticketDefinitionListServiceConfig={ticketDefinitionListServiceConfig}
    checkoutServiceConfig={{
      thankYouPageUrl: `${Astro.url.origin}/events/${slug}/thank-you`,
      noTicketDefinitionsSelectedError: 'Select a ticket',
    }}
    scheduleListServiceConfig={scheduleListServiceConfig}
    occurrenceListServiceConfig={occurrenceListServiceConfig}
    eventDetailsPagePath="/events/:slug"
    formPagePath="/events/:slug/form"
    schedulePagePath="/events/:slug/schedule"
  />
</BaseLayout>
