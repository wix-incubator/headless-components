---
import { BuyNowServiceProvider } from "./BuyNowServiceContext";
import { BuyNowServiceImplementation, BuyNowServiceDefinition } from "../services";
import { createServicesManager, createServicesMap } from '@wix/services-manager';

const map = createServicesMap().addService(BuyNowServiceDefinition, BuyNowServiceImplementation, {
  productId: Astro.props.productId,
  variantId: Astro.props.variantId,
});
const mgr = createServicesManager(map);
---

<BuyNowServiceProvider service={mgr.getService(BuyNowServiceDefinition)}>
  <context-provider data-intial-data={JSON.stringify(Astro.props)}>
    <slot />
  </context-provider>
</BuyNowServiceProvider>
<script>
  import { createServicesManager, createServicesMap } from '@wix/services-manager';
  import { BuyNowServiceImplementation, BuyNowServiceDefinition } from "../services";

  class ContextProvider extends HTMLElement {
    service: ReturnType<typeof BuyNowServiceImplementation>;
    constructor() {
      super();
      console.log("BuyNowServiceProvider ContextProvider::constructor", this.getAttribute("data-intial-data"));

      const map = createServicesMap().addService(BuyNowServiceDefinition, BuyNowServiceImplementation, JSON.parse(this.getAttribute("data-intial-data")!));
      const mgr = createServicesManager(map);
      const service = mgr.getService(BuyNowServiceDefinition);

      this.service = service;
      (globalThis as any).runDirectivePendingTaks && (globalThis as any).runDirectivePendingTaks();
    }

  }

  customElements.define("context-provider", ContextProvider);
</script>









<!--


<ManagerProvider factories={
  currentCartServiceDefinition,
}>
  <BuiyNo>
    <AdditionalProvider factories={
      productGalleryServiceDefinition,
      variantServiceDefinition,
    } />
    <Product></Product>
  </BuiyNo>
</ManagerProvider>

 -->
